---
title: "Comparison with other packages"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{comparison-with-other-packages}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, message=FALSE}
library(outstandR)
```

There are already a few widely-used R packages in CRAN to perform model-based standardization, such as [`{marginaleffects}`](https://marginaleffects.com/) and [`{stdReg}/{StdReg2}`](https://sachsmc.github.io/stdReg2/).

## marginaleffects

```{r , warning=FALSE, message=FALSE}
library(marginaleffects)
```


## stdReg[2]

`{StdReg}` has been rewritten to produce `{StdReg2}` which has "nicer output, more available methods, the possibility to include new methods, and mainly to make maintenance and updating easier." So, for this reason, we will use `{StdReg2}`.

We shall follow the article [_Estimation of causal effects using stdReg2_](https://sachsmc.github.io/stdReg2/articles/overview.html)

```{r, warning=FALSE, message=FALSE}
library(stdReg2)
library(causaldata)

# load dataset
# data(nhefs_complete, package = "causaldata")
nhefs_dat <- causaldata::nhefs_complete

m <- glm(wt82_71 ~ qsmk + sex + race + age + I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + wt71 + I(wt71^2), 
         data = nhefs_dat)
summary(m)

m2 <- standardize_glm(
  wt82_71 ~ qsmk + sex + race + age + I(age^2) + as.factor(education) + smokeintensity + I(smokeintensity^2) + smokeyrs + I(smokeyrs^2) + as.factor(exercise) + as.factor(active) + wt71 + I(wt71^2),
  data = nhefs_dat, 
  values = list(qsmk = c(0,1)),
  contrasts = c("difference", "ratio"),
  reference = 0)

m2
```

```{r}
library(dplyr)

##TODO: what to do with factors of more than 2 levels when aggregating?
# for now just remove them
# use dummy variables like for {nmarunr}. copy code

# education, exercise, active

##TODO: doubly-robust, separate treatment models?

nhefs_ipd <- nhefs_dat |> 
  select(qsmk, sex, race, age, smokeintensity, smokeyrs, wt71, wt82_71) |> 
  rename(trt = qsmk,
         y = wt82_71) |> 
  mutate(sex = as.numeric(sex),
         race = as.numeric(race))

# create aggregate data

nhefs.X <- nhefs_ipd %>%
  summarise(across(-c(trt, y),
                   list(mean = mean, sd = sd),
                   .names = "{fn}.{col}"))

nhefs.B <- dplyr::filter(nhefs_ipd, trt == 1) |> 
  summarise(y.B.sum = sum(y),
            y.B.bar = mean(y),
            y.B.sd = sd(y),
            N.B = n())

nhefs.C <- dplyr::filter(nhefs_ipd, trt == 0) |> 
  summarise(y.C.sum = sum(y),
            y.C.bar = mean(y),
            y.C.sd = sd(y),
            N.C = n())

nhefs_ald <- cbind.data.frame(nhefs.X, nhefs.C, nhefs.B)

##TODO: check how {outstandR} handles factor vs not factors?

lin_form <-
  as.formula(y ~ trt * (sex + race + age + I(age^2) +
               smokeintensity + I(smokeintensity^2) +
               smokeyrs + I(smokeyrs^2) + wt71 + I(wt71^2)))

##TODO: add explicit reference argument in set-up?
# reference = 0

nhefs_strat <- 
  strategy_gcomp_ml(formula = lin_form,
                    family = gaussian(link = "identity"))

res <- outstandR(BC.ALD = nhefs_ald,
                 AC.IPD = nhefs_ipd,
                 strategy = nhefs_strat,
                 scale = "risk_difference")
res
```



---

[ISPOR poster by Hatswell](https://www.ispor.org/heor-resources/presentations-database/presentation/euro2024-4016/141209) make a comparison of different MAIC R packages.

Of the packages considered, `{MAIC}` is not on CRAN so not included in our anaysis at the moment.

## maicplus


Roche developed `maic` which is now deprecated and replaced by `maicplus`.

## maicChecks


`maicChecks`

```{r, warning=FALSE, message=FALSE}
library(maicChecks)
```

---

For g-formula we will use `gFormulaMI` and `gfoRmula`.

## gfoRmula

```{r, warning=FALSE, message=FALSE}
library(gfoRmula)
```

## gFormulaMI

```{r, warning=FALSE, message=FALSE}
library(gFormulaMI)
```

